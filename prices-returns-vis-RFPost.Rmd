---
title: "Visualizing Returns and Distributions"
output:
  html_notebook: default
---

 
```{r setup, message = FALSE, include = FALSE}
# packages required for this post
for (pkg in c('tidyverse', 'tidyquant', 'timetk', 'tibbletime', 'highcharter')) 
  if (!requireNamespace(pkg)) install.packages(pkg)
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

In our previous post, we reviewed how to import daily prices and transform to monthly log returns and we reviewed 4 methods for making the transformation.  Today, we will work with just two of the objects from that post. 

By way of quick reminder, we are building toward analyzing the returns of a 5-asset portfolio consisting of the following.

    + SPY (S&P500 fund) weighted 25%
    + EFA (a non-US equities fund) weighted 25%
    + IJS (a small-cap value fund) weighted 20%
    + EEM (an emerging-mkts fund) weighted 20%
    + AGG (a bond fund) weighted 10%

Let's load up our packages.

```{r}
library(tidyverse)
library(tidyquant)
library(timetk)
library(tibbletime)
library(highcharter)
```

Pure repetition from last time: we will create one `xts` object and one tibble, in long format, of monthly log returns

```{r}
# The symbols vector holds our tickers. 
symbols <- c("SPY","EFA", "IJS", "EEM","AGG")

# The prices object will hold our raw price data throughout this book.
prices <- 
  getSymbols(symbols, src = 'yahoo', from = "2005-01-01", 
             auto.assign = TRUE, warnings = FALSE) %>% 
  map(~Ad(get(.))) %>% 
  reduce(merge) %>%
  `colnames<-`(symbols)
# XTS method
prices_monthly <- to.monthly(prices, indexAt = "last", OHLC = FALSE)
asset_returns_xts <- na.omit(Return.calculate(prices_monthly, method = "log"))

# Tidyverse method, to long, tidy format
asset_returns_long <- 
  prices %>% 
  to.monthly(indexAt = "last", OHLC = FALSE) %>% 
  tk_tbl(preserve_index = TRUE, rename_index = "date") %>%
  gather(asset, returns, -date) %>% 
  group_by(asset) %>%  
  mutate(returns = (log(returns) - log(lag(returns))))
```

We now have two objects holding monthly log returns, `assets_returns_xts` and `assets_returns_long`.  We will use `highcharter` to first visualize the `xts` formatted returns.

Highcharter is fantastic for visualizing a time series or many time series.  First, we set `highchart(type = "stock")` to get a nice time series line. Then we intuitively add each of our series to the highcharter code flow. In this case, we'll add our columns from the xts object.

```{r}
highchart(type = "stock") %>% 
  hc_title(text = "Monthly Log Returns") %>%
  hc_add_series(asset_returns_xts$SPY, 
                  name = names(asset_returns_xts$SPY)) %>%
  hc_add_series(asset_returns_xts$EFA, 
                  name = names(asset_returns_xts$EFA)) %>%
  hc_add_series(asset_returns_xts$IJS, 
                  name = names(asset_returns_xts$IJS)) %>%
  hc_add_theme(hc_theme_flat()) %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE)

```

We included only the first 3 time series above and it's already starting to get crowded. Besides that, the time series of log returns isn't giving much intuition about the distribution of the log returns. Highcharter does have the capacity for histogram making. One method is to first call the base function `hist` on the data along with the arguments for bin number and `plot = FALSE`. Then we can call `hchart` on that object. 

```{r, out.width= "70%"}
hc_spy <- hist(asset_returns_xts$SPY, breaks = 30, plot = FALSE)

hchart(hc_spy) %>% 
  hc_title(text = "SPY Log Returns Distribution")
```

Nothing wrong with that chart and it shows us the distribution. However, `highcharter` is missing an easy way to chart multiple histograms and to add density lines to those multiple historgrams.  The functionality is fine for one set of returns (as we'll see when we get to the portfolio) but here we want to see the distribution of all of our returns series together. 

For that, we will head to the tidyverse and use `ggplot` on our tidy tibble `assets_returns_long`. Because it is in long, tidy format, and it is grouped by the 'asset' column, we can chart the assets individually on one chart. 

```{r}

# Make so all titles centered
theme_update(plot.title = element_text(hjust = 0.5))

asset_returns_long %>% 
  ggplot(aes(x = returns, fill = asset)) + 
  geom_histogram(alpha = 0.25, binwidth = .01)
```

Let's use `facet_wrap(~asset)` to break these out by asset. We can add a title with `ggtitle`.

```{r}
asset_returns_long %>% 
  ggplot(aes(x = returns, fill = asset)) + 
  geom_histogram(alpha = 0.25, binwidth = .01) + 
  facet_wrap(~asset) + 
  ggtitle("Monthly Returns Since 2005")
```


```{r}

asset_returns_long %>% 
  ggplot(aes(x = returns, colour = asset, fill = asset)) +
  stat_density(geom = "line", alpha = 1) +
  #facet_wrap(~asset) +
  ggtitle("Monthly Returns Since 2005") +
  xlab("monthly returns") +
  ylab("distribution") 

```


```{r}
asset_returns_long %>% 
  ggplot(aes(x = returns, colour = asset, fill = asset)) +
  stat_density(geom = "line", alpha = 1) +
  facet_wrap(~asset) +
  ggtitle("Monthly Returns Since 2005") +
  xlab("monthly returns") +
  ylab("distribution") 
```

Now we can combine each of these plots into one nice, faceted plot. 

We will also do some heavy editing of the aesthetics of the plot. First off, let's choose a different color besides black to be the theme. I will go with cornflower blue, because it's a nice shade of blue and I don't see it used very frequently elsewhere. Once we have a color, we can choose the different elements of the chart to change in the the `theme` function. I make a lot of changes here by way of example but feel free to comment out a few of those lines and see the different options.


```{r}
asset_returns_long %>% 
  ggplot(aes(x = returns, colour = asset, fill = asset)) +
  stat_density(geom = "line", alpha = 1) +
  geom_histogram(alpha = 0.25, binwidth = .01) +
  facet_wrap(~asset) +
  ggtitle("Monthly Returns Since 2005") +
  xlab("monthly returns") +
  ylab("distribution") +
  theme(plot.title = element_text(colour = "cornflowerblue"),  
        strip.text.x = element_text(size = 8, colour = "cornflowerblue"), 
        strip.background = element_rect(colour = "cornflowerblue", fill = "white"), 
        axis.text.x = element_text(colour = "cornflowerblue"), 
        axis.text = element_text(colour = "cornflowerblue"), 
        axis.ticks.x = element_line(colour = "cornflowerblue"), 
        axis.text.y = element_text(colour = "cornflowerblue"), 
        axis.ticks.y = element_line(colour = "cornflowerblue"),
        axis.title = element_text(colour = "cornflowerblue"),
        legend.title = element_text(colour = "cornflowerblue"),
        legend.text = element_text(colour = "cornflowerblue")
        )
```

Eye-balling this, it appears that SPY and IJS are slightly right-skewed and AGG is the most peaked around 0.  That is far from a rigorous analysis but that's not we're after here. This chart of monthly returns is a tool to quickly glance at the data and see if anything unusual jumps out, or some sort of hypothesis comes to mind. We are going to be combining these assets into a portfolio and once that occurs, we will rarely view them in isolation again. These visualizations at least allow, or encourage, us to focus on the individual components before building the portfolio. 





